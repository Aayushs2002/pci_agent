# Use CentOS 8 Stream for RPM building
FROM centos:centos8

# Fix CentOS 8 repos (CentOS 8 reached EOL)
RUN cd /etc/yum.repos.d/ && \
    sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-* && \
    sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

# Install build tools
RUN yum update -y && \
    yum install -y \
    python3 \
    python3-pip \
    python3-devel \
    gcc \
    gcc-c++ \
    make \
    rpm-build \
    rpmdevtools \
    zlib-devel \
    libffi-devel \
    openssl-devel \
    && yum clean all

# Upgrade pip
RUN python3 -m pip install --upgrade pip

# Install Python build dependencies
RUN python3 -m pip install \
    pyinstaller>=5.13.0 \
    setuptools>=68.0.0 \
    wheel

# Set working directory
WORKDIR /build

# Copy agent source code
COPY . /build/

# Make build scripts executable
RUN chmod +x /build/build_agent.py /build/build_rpm.py 2>/dev/null || true

# Default command
CMD ["/bin/bash"]
